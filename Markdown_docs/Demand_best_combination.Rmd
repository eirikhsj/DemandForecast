---
title: "Demand - Best Combination"
author: "Eirik Sj√•vik"
date: "2023-03-02"
output: html_document
---

In this document we are looking at:
1) the best combination of time covariates model, both interaction and no interaction 
2) the best combination of Factor loading  model
3) the best overall combination


The results show 2 types of sensitivity to time interval
1) The Factor10_3 2FL model is not the best any more if we cut away the 2016-17. It is doing better later. 
2) The Climatology is also doing horribly the first two years, with performance stabilizing after 3 years. 
3) No question that we are doing better than climatology, but not as much. 

4) Even if PC2 does not contribute much alone, it does contribute when the model increases. 
5) Classic case of overfitting whit more than 2 PC components. 


Some BLAS problems 
Inter1$Result[pred_1<70000&pred_1>10000,sqrt(mean((volume - pred_1)^2))]
Because of problems with overflow. 

# 1) Load Models
```{r , include=FALSE}
library(DemandForecast)
library(data.table)
path = '/Users/Eirik/Desktop/Master2023/Output_data/output_demand_forecast_best_baseline/'
load(paste0(path, 'Year1.Rda'))
load(paste0(path, 'Climatology.Rda'))
load(paste0(path, 'Naive.Rda'))
load(paste0(path, 'No_inter_1.Rda'))
load(paste0(path, 'No_inter_2.Rda'))
load(paste0(path, 'No_inter_3.Rda'))
load(paste0(path, 'No_inter_4.Rda'))
load(paste0(path, 'No_inter_5.Rda'))
load(paste0(path, 'No_inter_6.Rda'))
load(paste0(path, 'No_inter_7.Rda'))
load(paste0(path, 'No_inter_8.Rda'))
load(paste0(path, 'Inter1.Rda'))
load(paste0(path, 'Inter2.Rda'))
load(paste0(path, 'Inter3.Rda'))
load(paste0(path, 'Inter4.Rda'))
load(paste0(path, 'Custom1.Rda'))
load(paste0(path, 'Custom2.Rda'))
load(paste0(path, 'Custom3.Rda'))
load(paste0(path, 'Custom4.Rda'))
load(paste0(path, 'Custom5.Rda'))
load(paste0(path, 'Custom6.Rda'))
load(paste0(path, 'Custom7.Rda'))
load(paste0(path, 'Custom8.Rda'))
load(paste0(path, 'Custom9.Rda'))
load(paste0(path, 'Custom10.Rda'))

load(paste0(path, 'Custom_lin1.Rda'))
load(paste0(path, 'Custom_lin2.Rda'))
load(paste0(path, 'Custom_lin3.Rda'))
load(paste0(path, 'Custom_lin4.Rda'))
load(paste0(path, 'Custom_lin5.Rda'))
load(paste0(path, 'Custom_lin6.Rda'))
load(paste0(path, 'Custom_lin7.Rda'))
load(paste0(path, 'Custom_lin8.Rda'))
load(paste0(path, 'Custom_lin9.Rda'))
load(paste0(path, 'Custom_lin10.Rda'))

load(paste0(path, 'Custom_comb1.Rda'))
load(paste0(path, 'Custom_comb2.Rda'))
load(paste0(path, 'Custom_comb3.Rda'))
load(paste0(path, 'Custom_comb4.Rda'))
load(paste0(path, 'Custom_comb5.Rda'))
load(paste0(path, 'Custom_comb6.Rda'))
load(paste0(path, 'Custom_comb7.Rda'))
load(paste0(path, 'Custom_comb8.Rda'))
load(paste0(path, 'Custom_comb9.Rda'))
load(paste0(path, 'Custom_comb10.Rda'))

load(paste0(path, 'Mean_temp1.Rda'))
load(paste0(path, 'Mean_temp2.Rda'))

load(paste0(path, 'Factor10_inter1.Rda'))
load(paste0(path, 'Factor10_inter2.Rda'))
load(paste0(path, 'Factor10_inter3.Rda'))
load(paste0(path, 'Factor10_inter4.Rda'))

load(paste0(path,"Custom_comb3_int.Rda"))
load(paste0(path,"Custom_comb4_int.Rda"))
load(paste0(path,"Custom_comb5_int.Rda"))
load(paste0(path,"Custom_comb6_int.Rda"))
load(paste0(path,"Custom_comb7_int.Rda"))
load(paste0(path,"Custom_comb8_int.Rda"))
load(paste0(path,"Custom_comb9_int.Rda"))
load(paste0(path,"Custom_comb10_int.Rda"))

load(paste0(path,"Custom_comb10_int_m_w.Rda"))
load(paste0(path,"Custom_comb9_int_m_w.Rda"))
load(paste0(path,"Custom_comb8_int_m_w.Rda"))
load(paste0(path,"Custom_comb7_int_m_w.Rda"))
load(paste0(path,"Custom_comb6_int_m_w.Rda"))
load(paste0(path,"Custom_comb5_int_m_w.Rda"))
load(paste0(path,"Custom_comb4_int_m_w.Rda"))
load(paste0(path,"Custom_comb3_int_m_w.Rda"))
load(paste0(path,"Custom_comb10_int_w_m.Rda"))
load(paste0(path,"Custom_comb9_int_w_m.Rda"))
load(paste0(path,"Custom_comb8_int_w_m.Rda"))
load(paste0(path,"Custom_comb7_int_w_m.Rda"))
load(paste0(path,"Custom_comb6_int_w_m.Rda"))
load(paste0(path,"Custom_comb5_int_w_m.Rda"))
load(paste0(path,"Custom_comb4_int_w_m.Rda"))
load(paste0(path,"Custom_comb3_int_w_m.Rda"))
load(paste0(path,"Custom_comb10_int_m_m.Rda"))
load(paste0(path,"Custom_comb9_int_m_m.Rda"))
load(paste0(path,"Custom_comb8_int_m_m.Rda"))
load(paste0(path,"Custom_comb7_int_m_m.Rda"))
load(paste0(path,"Custom_comb6_int_m_m.Rda"))
load(paste0(path,"Custom_comb5_int_m_m.Rda"))
load(paste0(path,"Custom_comb4_int_m_m.Rda"))
load(paste0(path,"Custom_comb3_int_m_m.Rda"))
load(paste0(path,"mean_m_w.Rda"))
load(paste0(path,"mean_w_w.Rda"))
load(paste0(path,"mean_w_m.Rda"))
load(paste0(path,"mean_m_m.Rda"))

```


# 2) Naive combination model 
```{r, eval = FALSE}
Naive= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                        p_comps = 0,  reg_form = "volume ~ hour + season + w_day + week + month + year")
```

# 3) Best model no interaction
```{r, eval = FALSE}
No_inter_1= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + month1 + month2 + season1 + season2 + year")

No_inter_2= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ s(hour)  + as.factor(w_day) + s(week) + month1 + month2 + season1 + season2 + year")

No_inter_3= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + as.factor(week) + month1 + month2 + season1 + season2 + year")

No_inter_4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + s(month) + season1 + season2 + year", incl_climatology = TRUE)

No_inter_5= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + month1 + month2 + as.factor(season1)+ year")

##############
No_inter_6= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ s(hour)  + as.factor(w_day) + s(week) + s(month) + season1 + season2 + year")

No_inter_7= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + as.factor(week) +s(month) + season1 + season2 + year")

No_inter_8= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + s(month) + as.factor(season1)+ year")
```


```{r, cache = TRUE}
plot(No_inter_1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700))
lines(No_inter_2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], col = 'red')
lines(No_inter_5$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_6$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_5$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_7$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(No_inter_1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700))
lines(No_inter_2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], col = 'red')
lines(No_inter_5$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_6$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_7$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_8$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
No_inter_1$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_2$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_3$Result[,sqrt(mean((volume - pred_1)^2))], 
No_inter_4$Result[,sqrt(mean((volume - pred_1)^2))], #Best s(month)
No_inter_5$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_6$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_7$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_8$Result[,sqrt(mean((volume - pred_1)^2))],
Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```

# 4) Interaction models
```{r, eval = FALSE}
Inter1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, 
                         train_y = 5, p_comps = 0,  
                         reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year")

Inter2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year")

Inter3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year") #Have run

Inter4 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year") #Have run
```


```{r, cache = TRUE}
plot(Inter1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700))
lines(Inter2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Inter3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Inter4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], col = 'red')

lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Inter1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700))
lines(Inter2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Inter3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Inter4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], col = 'red')

lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Inter1$Result[pred_1<70000&pred_1>10000,sqrt(mean((volume - pred_1)^2))],
#Inter1$Result[,sqrt(mean((volume - pred_1)^2))],
Inter2$Result[,sqrt(mean((volume - pred_1)^2))] ,
Inter3$Result[,sqrt(mean((volume - pred_1)^2))], 
Inter4$Result[,sqrt(mean((volume - pred_1)^2))], #Best s(month)

Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```




# 5a) Single Factor loading models (splines)
```{r, eval = FALSE}
Custom1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 's(PC1)',  reg_form = "volume ~ 1", cores =48)
Custom2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 2, custom = 's(PC2)',  reg_form = "volume ~ 1", cores =48)
Custom3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 3, custom = 's(PC3)',  reg_form = "volume ~ 1", cores =48)
Custom4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps =4, custom = 's(PC4)',  reg_form = "volume ~ 1", cores =48)
Custom5 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 5, custom = 's(PC5)',  reg_form = "volume ~ 1", cores =48)
Custom6 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 6, custom = 's(PC6)',  reg_form = "volume ~ 1", cores =48)
Custom7 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 7, custom = 's(PC7)',  reg_form = "volume ~ 1", cores =48)
Custom8 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 8, custom = 's(PC8)',  reg_form = "volume ~ 1", cores =48)
Custom9 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 9, custom = 's(PC9)',  reg_form = "volume ~ 1", cores =48)
Custom10 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10, custom = 's(PC10)',  reg_form = "volume ~ 1", cores =48)
```


```{r, cache = TRUE}
plot(Custom1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

Custom1$Result[,sqrt(mean((volume - pred_2)^2))]
Custom2$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom3$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom4$Result[,sqrt(mean((volume - pred_2)^2))] #Best s(month)
Custom5$Result[,sqrt(mean((volume - pred_2)^2))]
Custom6$Result[,sqrt(mean((volume - pred_2)^2))]
Custom7$Result[,sqrt(mean((volume - pred_2)^2))]
Custom8$Result[,sqrt(mean((volume - pred_2)^2))]
Custom9$Result[,sqrt(mean((volume - pred_2)^2))]
Custom10$Result[,sqrt(mean((volume - pred_2)^2))]
Naive$Result[,sqrt(mean((volume - pred_1)^2))]
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```

# 5b) Single Factor loading models (linear)
```{r, eval  = FALSE}
Custom_lin1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 'PC1',  reg_form = "volume ~ 1", cores =48)
Custom_lin2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 2, custom = 'PC2',  reg_form = "volume ~ 1", cores =48)
Custom_lin3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 3, custom = 'PC3',  reg_form = "volume ~ 1", cores =48)
Custom_lin4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps =4, custom = 'PC4',  reg_form = "volume ~ 1", cores =48)
Custom_lin5 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 5, custom = 'PC5',  reg_form = "volume ~ 1", cores =48)
Custom_lin6 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 6, custom = 'PC6',  reg_form = "volume ~ 1", cores =48)
Custom_lin7 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 7, custom = 'PC7',  reg_form = "volume ~ 1", cores =48)
Custom_lin8 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 8, custom = 'PC8',  reg_form = "volume ~ 1", cores =48)
Custom_lin9 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 9, custom = 'PC9',  reg_form = "volume ~ 1", cores =48)
Custom_lin10 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10, custom = 'PC10',  reg_form = "volume ~ 1", cores =48)
```

```{r, cache = TRUE}
plot(Custom_lin1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_lin2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_lin1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_lin2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

Custom_lin1$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin2$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom_lin3$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom_lin4$Result[,sqrt(mean((volume - pred_2)^2))] #Best s(month)
Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin6$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin7$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin8$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin9$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin10$Result[,sqrt(mean((volume - pred_2)^2))]
Naive$Result[,sqrt(mean((volume - pred_1)^2))]
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```



# 6) Mean temperature model 
```{r, eval=FALSE}
Mean_temp1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 'hourly_mean_grid',  reg_form = "volume ~ 1")

Mean_temp2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 's(hourly_mean_grid)',  reg_form = "volume ~ 1")
```

# 7a) Combinations of Increasing # of Factor loadings
```{r, eval=FALSE}
Custom_comb1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ 1", cores =48)
Custom_comb2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 2, custom = 's(PC1) + s(PC2)',  reg_form = "volume ~ 1", cores =48)
Custom_comb3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 3, custom = 's(PC1) + s(PC3)',  reg_form = "volume ~ 1", cores =48)
Custom_comb4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps =4, custom = 's(PC1) + s(PC4)',  reg_form = "volume ~ 1", cores =48)
Custom_comb5 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 5, custom = 's(PC1) + s(PC5)',  reg_form = "volume ~ 1", cores =48)
Custom_comb6 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 6, custom = 's(PC1) + s(PC6)',  reg_form = "volume ~ 1", cores =48)
Custom_comb7 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 7, custom = 's(PC1) + s(PC7)',  reg_form = "volume ~ 1", cores =48)
Custom_comb8 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 8, custom = 's(PC1) + s(PC8)',  reg_form = "volume ~ 1", cores =48)
Custom_comb9 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 9, custom = 's(PC1) + s(PC9)',  reg_form = "volume ~ 1", cores =48)
Custom_comb10 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10, custom = 's(PC1) + s(PC10)',  reg_form = "volume ~ 1", cores =48)
```





```{r, cache = TRUE}
plot(Custom_comb1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700))
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], col = 'red')
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_3)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_4)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_5)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_6)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_7)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_8)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_9)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_10)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date], col = 'blue')

plot(Custom_comb1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700))
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], col = 'red')
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_3)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_4)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_5)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_6)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_7)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_8)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_9)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_10)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)], col = 'blue')

print(c(
Custom_comb1$Result[,sqrt(mean((volume - pred_1)^2))], 
Custom_comb1$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb1$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_4)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_5)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_6)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_7)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_8)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_9)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_10)^2))],
Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```
# 7b) Combinations of 2 Factor loadings
```{r, cache = TRUE}
plot(Custom_comb2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb2$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb3$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10$Result[,sqrt(mean((volume - pred_2)^2))],
Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```

## Final 1 Best Demand Models (Increasing)

```{r, eval = FALSE}
Factor10_inter1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year", cores = 48)

Factor10_inter2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year", cores = 48) 

Factor10_inter3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year", cores = 48) 

Factor10_inter4 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year", cores = 48) #
```





```{r, cache=TRUE}
plot(Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(1600, 8000))
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2)), keyby = init_date], col = 'red')
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_4)^2)), keyby = init_date])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_5)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_6)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_7)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_8)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_9)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_10)^2)), keyby = init_date])

#lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date], col = 'blue')

plot(Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 6000))
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2)), keyby = month(init_date)], col = 'red')
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_4)^2)), keyby = month(init_date)])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_5)^2)), keyby = month(init_date)])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_6)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_7)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_8)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_9)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_10)^2)), keyby = month(init_date)])
#lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)], col = 'blue')

Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2))] #Best 
Factor10_inter3$Result[,sqrt(mean((volume - pred_4)^2))] 
Factor10_inter3$Result[,sqrt(mean((volume - pred_5)^2))] 
Factor10_inter3$Result[,sqrt(mean((volume - pred_6)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_7)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_8)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_9)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_10)^2))]
Naive$Result[,sqrt(mean((volume - pred_1)^2))]
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```

# Main plotting Function


## Final 2 Best Demand Model (Two models)
```{r}
for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_w_w"), mod)
}

for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_m_w"), mod)
}

for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_w_m"), mod)
}

for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_m_m"), mod)
}
```

### Plot
```{r, cache = TRUE}
plot(Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```


```{r, cache = TRUE}
plot(Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```


```{r, cache = TRUE}
plot(Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```


```{r}

w_w = c(
Inter1$Result[pred_1<70000&pred_1>10000,sqrt(mean((volume - pred_1)^2))],
Factor10_inter1$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter1$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))]
)


m_w = c(
Factor10_inter2$Result[,sqrt(mean((volume - pred_1)^2))],
Factor10_inter2$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter2$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))]
)

w_m = c(
Factor10_inter3$Result[,sqrt(mean((volume - pred_1)^2))],
Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))]
)

m_m = c(
Factor10_inter4$Result[,sqrt(mean((volume - pred_1)^2))],
Factor10_inter4$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter4$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))]

)
pdf("/Users/Eirik/Desktop/Master2023/ExportedPlots/Best_final_demand2.pdf", height = 7, width = 7, pointsize = 12)
#layout(matrix(c(1,2,3,3), 2, 2, byrow = TRUE))
x = seq(1:length(m_m))-1
plot(x, w_m, type = 'l', cex.lab = 1.3, cex.main = 1.5, pch = 16, col = "red", main = "Test Error", ylab = "Test Error (RMSE)", xlab = "Factor Loadings in Model")  
points(x, w_m, pch = 16, col = "red")
lines(x, m_m, lty = 2, col = 'grey')
lines(x, m_w, lty = 2, col = 'grey')
lines(x, w_w, lty = 2, col = 'grey')
legend(leg_place, lty = 1, cex = 1, pch = 16, col = c('red', 'grey', 'blue'), legend = c("Test Errors", "Test Error (Alt Params)", "Test Errors (Increasing)"))
lines(x, Factor10_inter3$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'blue')
dev.off()
```


## Final 3 Best Demand Model (Mean Grid)
```{r}
mean_w_w = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                                      pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
cores = 48, reg_form = "volume~1")
save(mean_w_w, file = 'mean_w_w.Rda')

mean_w_m = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                           pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                           custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
                           cores = 48, reg_form = "volume~1")
save(mean_w_m, file = 'mean_w_m.Rda')

mean_m_w = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                           pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                           custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
                           cores = 48, reg_form = "volume~1")
save(mean_m_w, file = 'mean_m_w.Rda')

mean_m_m = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                           pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                           custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
                           cores = 48, reg_form = "volume~1")
save(mean_m_m, file = 'mean_m_m.Rda')
```

```{r, cache=TRUE}
plot(mean_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(1600, 8000))
lines(mean_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], col = 'red')
lines(mean_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(mean_w_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date], col = 'blue')

plot(mean_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 6000))
lines(mean_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], col = 'red')
lines(mean_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(mean_w_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], col = 'purple')
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2)), keyby = month(init_date)], col = 'orange')
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)], col = 'blue')

mean_m_m$Result[,sqrt(mean((volume - pred_2)^2))]
mean_m_w$Result[,sqrt(mean((volume - pred_2)^2))] 
mean_w_m$Result[,sqrt(mean((volume - pred_2)^2))] #Best 
mean_w_w$Result[,sqrt(mean((volume - pred_2)^2))] 
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```
#Numbers for  Factor10_1 are missing a month due to BLAS error. 
```{r, cache = TRUE}
Errorplot_factor_loading = function(data, plot_title = "Train and Test Error (2016-01:2023-01)", leg_place = 'topright', total_var = 11){
    
    test_pc = paste0('pred_', 1:total_var)
    train_pc = paste0('RMSE_train_', 1:total_var)
    test_plot = data[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc]
    #train_plot = data[, lapply(.SD, function(x) mean(x)), .SDcols = train_pc]
    Mrg = merge(Year1$Results[,.(date, hour, lead_time,N_train_1)], 
                data, 
                by = c("date", "hour", "lead_time"))

    train_plot = rep(NA, total_var)
    for (i in 1:total_var){
        vars = c("N_train_1", "lead_time", train_pc[i])
        Mrg_omit = na.omit(Mrg[,..vars])
        train_plot[i] = Mrg_omit[lead_time==361,sum(get(train_pc[i])*N_train_1, na.rm = FALSE)/ sum(N_train_1)]
    }
    #print(test_plot)
    x = seq(1:length(test_plot))-1
    
    
    par(mar=c(5,5,5,5))
    # Test plot
    plot(x, test_plot, type = 'l', cex.lab = 1.3, cex.main = 1.5, pch = 16, col = "red", main = paste(plot_title), ylab = "Test Error", xlab = "Number of Factor Loadings in Model")  
    points(x, test_plot, pch = 16, col = "red")
    lines(x, Factor10_inter2$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'grey')
    lines(x, Factor10_inter1$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'grey')
    lines(x, Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'grey')
    par(new = TRUE)         #new axis
    
    # Train plot
    plot(x, train_plot, type = 'l', cex.lab = 1.7, col = "black", axes = FALSE, xlab = "", ylab = "")
    points(x, train_plot, pch = 16, col = "black")
    
    axis(side = 4, at = pretty(range(train_plot)))      
    mtext("Train Error", side = 4, line = 3, cex = 1.3)
    legend(leg_place, lty = 1, cex = 1, pch = 16, col = c('red', 'black', 'grey'), legend = c("Test Errors", "Training Errors", "Test Error (Alt Params)"))
}

test_pc = paste0('pred_', 1:11)
train_pc = paste0('RMSE_train_', 1:11)
pdf("Best_final_demand.pdf", height = 5, width = 7, pointsize = 12)
Errorplot_factor_loading(Factor10_inter3$Results)
dev.off()

Errorplot_factor_loading(Factor10_inter3$Results[init_date>'2018-06-01',]) #Greys are not adjusted here


by_init =Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc, by = init_date]

#by_init[, lapply(.SD, function(x) mean(x)), .SDcols = test_pc]

Factor10_results = rbind(
Factor10_inter1$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm = TRUE))), .SDcols = test_pc],
Factor10_inter2$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc],
Factor10_inter3$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc],
Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc]
)

print(t(Factor10_results))

#Factor10_inter1_real[, lapply(.SD, function(x) sqrt(mean((volume - x)^2,na.rm = TRUE))), .SDcols = test_pc]


###################################
#Skill by month

pdf("/Users/Eirik/Desktop/Master2023/ExportedPlots/GAM_FL2_3_skill_demand2.pdf", height = 7, width = 7, pointsize = 12)
layout(matrix(c(1,2,3,3), 2, 2, byrow = TRUE))
par(mar = c(4, 4, 4, 4))
plot(1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = month(date)][,V1]/
              Climatology$Results[, mean((volume - clima_pred)^2), keyby = month(date)][,V1]),
     type = 'l', ylim = c(-0.5, 1), xlab = 'Month', ylab = '', xaxt ='n',
     main = 'Skill of GAM-FL2 by Month', col = 'blue')


legend('top', cex = 0.7, pch = 16, col = c('blue','orange', 'black'), lty = c(1,2,1), title = 'Skill of GAM-FL2 relative to:', legend = c("Climatology", "Time Interaction", "GAM-FL1"))
abline(h = 0, col = 'black')
lines(1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = month(date)][,V1]/
               Inter4$Result[, mean((volume - pred_1)^2), keyby = month(date)][,V1]), col = rgb(1,0.5,0,0.65), lty = 2)
lines(1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = month(date)][,V1]/
               Factor10_inter3$Result[, mean((volume - pred_2)^2), keyby = month(date)][,V1]), col = 'black')
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = month][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
mtext("Skill Score", side = 2, line = 3, cex = 0.8, padj = 1.4)
ticks <- seq_len(12)
#axis(side = 1, at = ticks - 0.5, labels = FALSE)
axis(month.abb, side = 1, labels = month.abb, at = 1:12)
#By hour
plot(1:24,1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = hour][,V1]/
              Climatology$Results[, mean((volume - clima_pred)^2), keyby = hour][,V1]),
     type = 'l', ylim = c(-0.5, 1), xlab = 'Hour', ylab = '',xaxt = 'n',yaxt = 'n',
     main = 'Skill by Hour', col ='red')
abline(h = 0, col = 'black')
axis(1, at = c(1,6,12,18,24))
axis(side = 1, at = seq(1:24), labels = rep('', 24), tcl = 0.1)
lines(1:24,1 - (Factor10_inter3$Results[,  mean((volume - pred_2)^2), keyby = hour][,V1]/
               Climatology$Results[, mean((volume - clima_pred)^2), keyby = hour][,V1]),col = 'black')
lines(1:24,1 - (Factor10_inter3$Results[,  sqrt(mean((volume - pred_1)^2)), keyby = hour][,V1]/
               Climatology$Results[, sqrt(mean((volume - clima_pred)^2)), keyby = hour][,V1])^2,col = rgb(1,0.5,0,0.65), lty = 2)

legend('topright', lty = c(1,1,2), cex = 0.7, pch = 16, col = c('black', 'red', 'orange'), title = 'Skill relative to Climatology of:', legend = c("GAM-FL1", "GAM-FL2", "Time Interaction"))
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = hour][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
axis(side = 4, at = pretty(range(0, 4000)))      
    mtext("RMSE", side = 4, line = 3, cex = 0.8, padj = -1.4)

#Skill by init month
dates = unique(Factor10_inter3$Results$init_date)
plot(1:length(unique(Factor10_inter3$Results$init_date)),1 - (Factor10_inter3$Results[, mean((volume - pred_3)^2), keyby = init_date][,V1]/
              Climatology$Results[, mean((volume - clima_pred)^2), keyby = init_date][,V1]),
     type = 'l', ylim = c(-1.7, 1), xlab = 'Initialization Month', ylab = '',xaxt = 'n',
     main = 'Skill by Initialization Month', col = 'red')
axis(1, at = seq(1,length(dates), by = 6),labels = format(dates[seq(1, length(dates), by = 6)], "%b-%y"))
axis(side = 1, at = seq(1:85), labels = rep('', 85), tcl = 0.1)
abline(h = 0)

lines(1:length(unique(Factor10_inter3$Results$init_date)),1 - (Factor10_inter3$Results[,  sqrt(mean((volume - pred_2)^2)), keyby = init_date][,V1]/
               Climatology$Results[, sqrt(mean((volume - clima_pred)^2)), keyby = init_date][,V1])^2,col = 'black')

lines(1:length(unique(Factor10_inter3$Results$init_date)),1 - (Factor10_inter3$Results[,  sqrt(mean((volume - pred_1)^2)), keyby = init_date][,V1]/
               Climatology$Results[, sqrt(mean((volume - clima_pred)^2)), keyby = init_date][,V1])^2,col = rgb(1,0.5,0,0.65), lty = 2)
legend('left', lty = c(1,1,2), cex = 0.7, pch = 16, col = c('black', 'red', 'orange'), title = 'Skill relative to Climatology of:', legend = c("GAM-FL1", "GAM-FL2", "Interaction"))
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = init_date][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
axis(side = 4, at = pretty(range(0, 10000)))      
mtext("RMSE", side = 4, line = 3, cex = 0.8, padj = -1.4)
mtext("Skill Score", side = 2, line = 3, cex = 0.8, padj = 1.4)

dev.off()

#####################

#Skill by month after 2018
plot(month.abb,1 - (Factor10_inter3$Results[init_date>'2018-03-01',  sqrt(mean((volume - pred_3)^2)), keyby = month(date)][,V1]/
              Climatology$Results[init_date>'2018-03-01', sqrt(mean((volume - clima_pred)^2)), keyby = month(date)][,V1])^2,
     type = 'l', ylim = c(0, 0.8), xlab = 'Month', ylab = 'Skill Score',
     main = 'Skill of GAMFL2 by Month')
axis(month.abb, side = 4, labels = month.abb, at = 1:12)
legend('topright', lty = 1, cex = 1, pch = 16, col = c('black','red'), title = 'Skill relative to:', legend = c("Climatology", "Time Interaction"))

lines(1 - (Factor10_inter3$Results[init_date>'2018-03-01',  sqrt(mean((volume - pred_3)^2)), keyby = month(date)][,V1]/
               Inter4$Result[init_date>'2018-03-01', sqrt(mean((volume - pred_1)^2)), keyby = month(date)][,V1])^2, col = 'red')

plot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = lead_time], type = 'l', main = "RMSE by lead time", ylab = "RMSE", xlab = "Lead Time")
lin_mod = lm(V1 ~ lead_time, data = Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = lead_time])
lines(361:1080, predict(lin_mod))
abline(h = coef(lin_mod)[1])
#Mrg[lead_time==361, sum(RMSE_train_3*N_train_1)/ sum(N_train_1)]d
```

```{r}

ggplot(data = setnames(data.table(x, 
                                  y1 = as.numeric(as.list(y1)), 
                                  y2,
                                  , 
                                , 
       Int4= as.numeric(as.list(Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc]))),
                       old="V2", new="y1", skip_absent=TRUE),aes(x))+
    geom_line(aes(y = y1, color = "line1", shape = "line1"), linetype = "solid") +
    geom_point(aes(y = y1,color = "line1", shape = "line1"))+
    geom_line(aes(y = y2,color = "line2", shape = "line1")) +
    geom_point(aes(y = y2,color = "line2", shape = "line1"))+
    geom_line(aes(y = Int1,color = "line3", shape = "line1")) +
    geom_point(aes(y = Int1,color = "line3", shape = "line1"))+
geom_line(aes(y = Int2,color = "line4", shape = "line1")) +
    geom_point(aes(y = Int2,color = "line4", shape = "line1"))+
geom_line(aes(y = Int4,color = "line5", shape = "line1")) +
    geom_point(aes(y = Int4,color = "line5", shape = "line1"))+
    scale_color_manual(values = c("line1" = "red", "line2" = "black", "line3" = "grey", "line4" = "grey","line5" = "grey")) +
    scale_shape_manual(values = c("line1" = 16, "line2" = 16, "line3" = 16, "line4" = 16))+
    
    theme(legend.position = c(0.90, 0.20), legend.key.size = unit(0.3, "cm"))+
    labs(color = "Aggregation \n Interval :", x = "Number of Factor Loadings in Model", y = "RMSE",title = "Training and Test Errors", subtitle = "2016-01:2023-01", shape = "Group", linetype = "Group")
Int1 = as.numeric(as.list(Factor10_inter1$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc]))
Int2 = as.numeric(as.list(Factor10_inter2$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc]))
Int3= as.numeric(as.list(Factor10_inter3$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc]))
Int4= as.numeric(as.list(Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc]))

Mrg = merge(Year1$Results[,.(date, hour, lead_time,N_train_1)], 
                Factor10_inter3$Results, 
                by = c("date", "hour", "lead_time"))

    train_plot = rep(NA, total_var)
    for (i in 1:total_var){
        vars = c("N_train_1", "lead_time", train_pc[i])
        Mrg_omit = na.omit(Mrg[,..vars])
        train_plot[i] = Mrg_omit[lead_time==361,sum(get(train_pc[i])*N_train_1, na.rm = FALSE)/ sum(N_train_1)]
    }

df <- data.frame(
    x = rep(1:11, 5)-1,
    y = c(Int2,Int2,Int3,Int4,train_plot*1.1),
    group = rep(1:5, each = 11)
)

ggplot(df, aes(x = x, y = y, color = factor(group))) +
    geom_line() +
    geom_point() +
    labs(color = "Group") +
    scale_color_manual(values = c("grey", "grey", "red", "grey", "black"),labels = c("A", "A", "Test Error (Best)", "A", "Training Error (Best)")) +
    theme_classic()+
    scale_x_discrete(labels = c(0:10))+
    scale_y_continuous(name = "Test Error (RMSE)",
                sec.axis = sec_axis(~./1.1, name="Training Error (RMSE)"))+
    theme(legend.position = c(0.80, 0.80), legend.key.size = unit(0.4, "cm"))+
    labs(color = "Model:", x = "Number of Factor Loadings in Model", title = "Training and Test Errors", subtitle = "2016-01:2023-01")
```



```{r, cache=TRUE}
acf(Factor10_inter3$Result[,volume -pred_2])
```



# Compare combination Models
```{r, cache=TRUE}

plot(Factor10_inter3$Result[,volume])
lines(Factor10_inter3$Result[,volume], col = 'red')

plot(Factor10_inter3$Result[year(date) ==yr & month %in% c(4,5) & hour %in% c(6,12,18,24),volume], cex = 0.4)
#lines(Baseline_old$Result[year(date) ==2019& month ==3,pred_1], col = 'blue')
lines(Climatology$Result[year(date) ==yr& month %in% c(4,5)& hour %in% c(6,12,18,24),clima_pred], col = 'blue')
#lines(Best$Result[year(date) ==2019& month ==3,pred_2], col = 'red', lty = 2)
lines(Factor10_inter3$Result[year(date) ==yr& month %in% c(4,5)& hour %in% c(6,12,18,24),pred_3], col = 'red')

#lines(Naive$Result[year(date) ==2019& month ==3,pred_1], col = 'yellow', lty = 2)

plot(Factor10_inter3$Result[year(date) ==yr,volume -pred_3], col = 'purple', type = 'l')
acf(Factor10_inter3$Result[year(date) ==yr,volume -pred_3])
acf(Factor10_inter3$Result[,volume -pred_3])
```

# Make a temperature plot with 
1) Loss for all years
1) Compare temp for 2016 against mean temp over all year per hour, day
2) Compare predictions from baseline model and best model for 2016
3) Compare volume for that year


Skill by month
Show difference to pure climatology model. 

jensens inequality read up

Instead of doing the squared error directly

we sum the predictions for each day and compared for summed volume. 

the other version has a rational for stake holders


```{r}
plot(1:85, 1 - Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = init_date][,V1]/
         Climatology$Results[, mean((volume - clima_pred)^2), keyby =init_date][,V1],
     type = 'l', ylim = c(-2.5, 1), xlab = "", ylab = "", xaxt = 'n')
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = init_date][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
```



```{r, cache = TRUE}
if(file.exists("~/Desktop/Master2023/Data/")){
    prep = prep_demand_temp_data(include_na_volume = FALSE, 
                          path = "~/Desktop/Master2023/Data/")
}else{
    prep = prep_demand_temp_data(include_na_volume = FALSE)
}
#
X_mat = prep$X_mat #Temperature field
date_demand = prep$date_demand
X_mean = rowMeans(X_mat) - 273.15
date_demand[, grid_mean_temp:= X_mean]
date_demand[, climatology:= mean(grid_mean_temp), by = .(hour, yday(date))]
date_demand[, climat_volume:= mean(volume), by = .(hour, week(date))]
#(lat 4-25, long 55-75), 
pdf("/Users/Eirik/Desktop/Master2023/ExportedPlots/Pred_vs_actual_4_demand.pdf", height = 7, width = 9, pointsize = 12)
layout(matrix(c(1,2,3,4), 2, 2, byrow = TRUE))
par(mar = c(3.4, 3.2, 2, 3.2))

yr = 2021
#PLOT 1: Daily skill level one year
plot(1 - Factor10_inter3$Results[year(date)==yr,  mean((volume - pred_3)^2), keyby = week(date)][,V1]/
              Climatology$Results[year(date)==yr, mean((volume - clima_pred)^2), keyby = week(date)][,V1],
     type = 'l', ylim = c(-0.8, 1), xlab = "", ylab = "", xaxt = 'n',
     main = paste0('Skill of GAM-FL2 by Week (', yr,')'))
abline(h = 0, col = 'black')
rect(9.5, -7, 10.5, par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
rect(48.5, -7, 49.5, par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
axis(1, at = c(1, 10, 19, 27, 36, 45, 53), labels = c(format(Factor10_inter3$Results[year(date)==yr,  .(date,mean((volume - pred_3)^2)), keyby = week(date)][, .(date= date[1]), by = V2][c(1, 10, 19, 27, 36, 45),date],  "%b"), 'Jan'))
legend('bottomleft', lty = c(1,2), cex = 0.7, col = c('black','orange'), title = 'Skill relative to:', legend = c("Climatology", "Time Interaction"),bg = "white")
lines(1 - (Factor10_inter3$Results[year(date)==yr,  mean((volume - pred_3)^2), keyby = week(date)][,V1]/
               Inter4$Result[year(date)==yr, mean((volume - pred_1)^2), keyby = week(date)][,V1]), col = 'orange', lty = 2)
lines(1 - (Factor10_inter3$Results[year(date)==yr,  mean((volume - pred_2)^2), keyby = week(date)][,V1]/
               Inter4$Result[year(date)==yr, mean((volume - pred_1)^2), keyby = week(date)][,V1]), col = 'red', lty = 2)
lines(1 - Factor10_inter3$Results[year(date)==yr,  mean((volume - pred_2)^2), keyby = week(date)][,V1]/
              Climatology$Results[year(date)==yr, mean((volume - clima_pred)^2), keyby = week(date)][,V1], col = 'brown')
mtext(paste0('Month (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)
mtext('Skill Score', side = 2, line = 3, cex = 0.8, padj = 1.4)
mtext('Week 10', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.25)
mtext('Week 49', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.85)

#PLOT 2: Daily Mean Grid Temp
plot(date_demand[year(date)==yr & hour %in%12,.(date, climatology)], type = 'l', 
     ylim = c(-13, 17), ylab = '', xlab = "", main = paste0('Temperature vs Demand at 12:00 (', yr,')'))
lines(date_demand[year(date)==yr & hour %in%12,.(date, grid_mean_temp)], col = 'red')

rect(as.Date('2021-02-25'), par("usr")[3], as.Date('2021-03-03'), par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
rect(as.Date('2021-12-02'), par("usr")[3], as.Date('2021-12-09'), par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
legend('bottomleft', lty = 1, cex = 0.7, col = c('green', 'blue'), legend = c(paste0("Observed (",yr,")"),"Climatology (2013-23)"), title = 'Daily Mean Grid Temperature:',bg = "white")
legend('bottomright', lty = 1, cex = 0.7, col = c('red', 'black'), legend = c(paste0("Observed (",yr,")"),"Climatology (2013-23)"), title = 'Weekly Mean Demand:',bg = "white")
par(new=TRUE)
plot(date_demand[year(date)==yr & hour %in%12,.(date,mean(volume)), keyby = week(date)][,.(date,V2)], type = 'l', cex.lab = 1.7, col = "green", axes = FALSE, xlab = "", ylab = "", ylim = c(32000, 62500))
axis(side = 4, at = pretty(range(date_demand[year(date)==yr & hour %in%12,.(date, volume)][,volume]))) 
lines(date_demand[year(date)==yr & hour %in%12,.(date, climat_volume)], col = 'blue')
mtext('Temperature (¬∞C)', side = 2, line = 3, cex = 0.8, padj = 1.4)
mtext("Energy Demand Volume (MWh)", side = 4, line = 3, cex = 0.8, padj = -1.4)
mtext(paste0('Month (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)

mtext('Week 10', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.23)
mtext('Week 49', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.865)

#par(new=TRUE)
#plot(Factor10_inter3$Results[year(date)==yr & hour %in%12,PC1], col = 'purple', type = 'l', axes = FALSE, xlab = "", ylab = "")

#PLOT 3: Predicted vs Actual
ww1 = 10
plot(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,volume], col = 'black', ylim = c(32000, 62500), pch = 16, cex= 0.6,xlab = "", main = paste0('Predicted vs Actual - Week ',  ww1, ' (', yr, ')'), xaxt = 'n', ylab = '')
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,pred_3], col = 'red')
lines(Climatology$Results[year(date) == yr & week(date) == ww1,clima_pred], col = 'blue', lty = 1)
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,pred_1], col = 'orange', lty = 2)
#lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,pred_2], col = 'pink', lty = 1)
legend('bottomleft', lty = 1, cex = 0.7, col = c('red', 'blue', 'orange'), legend = c('GAM-FL2',"Climatology", 'Time Interaction'), title = 'Model:')
axis(1, at = c(seq(1,168, by = 24), 168), labels = c(format(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,date][seq(1,168, by = 24)], "%d-%b"), '11-Mar'))
mtext(paste0('Date (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)
mtext('Energy Demand Volume (MWh)', side = 2, line = 3, cex = 0.8, padj = 1.4)

#PLOT 4: Predicted vs Actual
ww2 = 49
plot(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,volume], col = 'black', ylim = c(32000, 62500), pch = 16, cex= 0.6,xlab = "", main = paste0('Predicted vs Actual - Week ',  ww2, ' (', yr, ')'), xaxt = 'n', ylab = '')
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,pred_3], col = 'red')
lines(Climatology$Results[year(date) == yr & week(date) == ww2,clima_pred], col = 'blue', lty = 1)
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,pred_1], col = 'orange', lty = 2)
legend('bottomleft', lty = 1, cex = 0.7, col = c('red', 'blue', 'orange'), legend = c('GAM-FL2',"Climatology", 'Time Interaction'), title = 'Model:')
axis(1, at = c(seq(1,168, by = 24), 168), labels = c(format(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,date][seq(1,168, by = 24)], "%d-%b"), '09-Dec'))
mtext(paste0('Date (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)
mtext('Energy Demand Volume (MWh)', side = 2, line = 3, cex = 0.8, padj = 1.4)
dev.off()

######################

plot(date_demand[year(date)==yr & hour %in%12 & month == 3,.(date, climatology)], type = 'l', 
     ylim = c(-9, 16), ylab = 'Temperature (¬∞C)', xlab = 'Date', main = 'Daily Mean Grid Temperature at 12:00 (lat 4-25, long 55-75)')
lines(date_demand[year(date)==yr & hour %in%12& month == 3,.(date, grid_mean_temp)], col = 'red')
legend('bottomright', lty = 1, cex = 0.7, col = c('red', 'black'), legend = c(paste0(yr, " observed"),"Climatology"), title = 'Temperature')


date_demand[, climatology:= mean(grid_mean_temp), by = .(yday(date))]
date_demand[, mm_temp:= mean(grid_mean_temp), by = date]
plot(date_demand[year(date)==2022,.(date, mm_temp)], type = 'l', ylim = c(-8.7, 17))
lines(date_demand[year(date)==2022,.(date, climatology)], col = 'red')

date_demand[, mean_vol:= mean(volume), by = date]

plot(date_demand[year(date)==yr &  wday(date)  %in% c(1) &hour %in%12,volume, keyby = date], col = 'black', ylim = c(30000, 65000), pch = 16, cex= 0.6, type = 'l')

#Reason for including weekday-term 
hour_x = 24
plot(date_demand[year(date)==yr &  wday(date)  %in% c(1) &hour %in%hour_x,volume, keyby = date], col = 'black', ylim = c(25000, 65000), pch = 16, cex= 0.6, type = 'l', main = paste0('Difference between weekdays at ', hour_x, ':00.Rda'))
for (i in 2:7){
    lines(date_demand[year(date)==yr &  wday(date)  %in% c(i) &hour %in%hour_x,volume, keyby = date], col = i)
}

# "2014-02-15" "2014-04-15" "2014-06-15" "2014-08-15"
# "2014-09-15" "2014-11-15" "2015-01-15" "2015-02-15" "2015-04-15" "2015-06-15"
# "2015-08-15" "2015-09-15" "2015-11-15" "2016-01-15" "2016-02-15" "2016-04-15"
# "2016-06-15" "2016-08-15" "2016-09-15" "2016-11-15" "2017-01-15" "2017-02-15"
# "2017-04-15" "2017-06-15" "2017-08-15" "2017-09-15" "2017-11-15" "2018-01-15"
# "2018-02-15" "2018-04-15" "2018-06-15" "2018-08-15" "2018-09-15" "2018-11-15"
# "2019-01-15" "2019-02-15" "2019-04-15" "2019-06-15" "2019-08-15" "2019-09-15"
# "2019-11-15" "2020-01-15" "2020-02-15" "2020-04-15" "2020-06-15" "2020-08-15"
# "2020-09-15" "2020-11-15" "2021-01-15" "2021-02-15" "2021-04-15" "2021-06-15"
# "2021-08-15" "2021-09-15"

```


What quality of the PCA are we leveraging


# permutation test
```{r}
 
# group1 = Factor10_inter3$Results[sample(1:60000, 100),(volume - pred_3)^2]
# group2 = Climatology$Results[sample(1:60000, 100),(clima_pred - volume)^2]
#group1 = Custom_comb6$Results[,(volume - pred_2)^2]
#group2 = Custom_comb1$Results[,(volume - pred_2)^2]

# group1 = Factor10_inter3$Result[,(volume - pred_1)^2]
# group2 = Custom_comb1$Results[,(volume - pred_1)^2]
# group1 = Factor10_inter3$Result[,(volume - pred_2)^2]
# group2 = mean_w_m$Results[,(volume - pred_2)^2]

perm_test = function(group1, group2, N){
    # Define test statistic 
    test_stat = function(x, y) {
      return(1 - mean(x)/mean(y))
    }
    
    # Observed test statistic
    observed = test_stat(group1, group2)
    
    # Create null distribution by permuting data
    n_permutations = N
    n_obs = length(group1)
    H0 = replicate(n_permutations, {
      combined = sample(c(group1, group2))
      test_stat(combined[1:n_obs], combined[(n_obs + 1):(n_obs*2)])
    })
    
    # Calculate p-value
    p_value = sum(H0 >= observed) / n_permutations
    
    # Print results
    cat("Observed test statistic:", observed, "\n")
    cat("P-value:", p_value, "\n")
}

group1 = Factor10_inter3$Results[,(volume - pred_3)^2]
group2 = Climatology$Results[,(clima_pred - volume)^2]
perm_test(group1,group2, 10000)
#Observed test statistic: 0.5873277 
#P-value: 0 
group1 = Factor10_inter3$Results[,(volume - pred_3)^2]
group2 = Factor10_inter3$Results[,(volume - pred_2)^2]
perm_test(group1,group2, 10000)
#Observed test statistic: 0.07941795 
#P-value: 0 
```

### Month based
```{r}
group1 = Factor10_inter3$Result[,mean((volume - pred_3)^2), by = init_date][,V1]
group2 = Climatology$Results[,mean((clima_pred - volume)^2) , by = init_date][,V1]


group1 = Factor10_inter3$Result[,mean((volume - pred_2)^2), by = init_date][,V1]
group2 = mean_w_m$Results[,mean((volume - pred_2)^2) , by = init_date][,V1]
# group1 = Factor10_inter3$Result[sample(1:60000, 100),(volume - pred_3)^2]
# group2 = Climatology$Results[sample(1:60000, 100),(clima_pred - volume)^2]
# group1 = Custom_comb6$Result[,mean((volume - pred_2)^2), by = init_date][,V1]
# group2 = Custom_comb1$Results[,mean((volume - pred_2)^2), by = init_date][,V1]

# group1 = Factor10_inter3$Result[,(volume - pred_1)^2]
# group2 = Custom_comb1$Results[,(volume - pred_1)^2]

# Define test statistic 
test_stat = function(x, y) {
  return(1 - mean(x)/mean(y))
}

#  Observed test statistic
observed = test_stat(group1, group2)

# Create null distribution by permuting data
n_permutations = 10000
n_obs = length(group1)
H0 = replicate(n_permutations, {
  combined = sample(c(group1, group2))
  test_stat(combined[1:n_obs], combined[(n_obs + 1):(n_obs*2)])
})

# Calculate p-value
p_value = sum(H0 >= observed) / n_permutations

# Print results
cat("Observed test statistic:", observed, "\n")
cat("P-value:", p_value, "\n")


```

XGB results
```{r}
#alpha = 0
#factor 
#eta = 0.5
# nrounds = seq(10,150,10)
xgplot_factor = data.table(x = c(seq(10,150,10)), y =c(
    2871.526,2728.313,2671.439,2645.374,2630.847,2622.644,2618.291,2616.214,2615.470,2615.536,2616.114,2617.001,2618.066,2619.233,2620.455
)) 
xgplot_factor_alpha_90 = data.table(x = c(0.5, 1, 3, 4,5,6, 8, 10, 15), y =c(
    2612.785,2610.705, 2607.154, 2607.743, 2608.678, 2609.875, 2612.061,2613.463,2619.467
)) 
xgplot_factor_alpha_3 = data.table(x = c(seq(70,150, 5)), y =c(
    2612.496, 2610.68, 2609.268, 2608.128, 2607.154, 2606.451, 2605.974, 2605.544, 2605.301,2605.199, 2605.169, 2605.261, 2605.451, 2605.72, 2605.953,2606.222,2606.506
)) 
xgplot_factor_alpha_3_120 = data.table(x = c(2, 2.5, 2.75,3, 3.25,3.5, 4, 4.5, 5), y =c(2606.958, 2605.843,2605.454,2605.169,2605.115, 2604.972, 2604.951, 2605.032,2605.345
)) 
# best at M = 120, alpha = 4: 2604.951

#alpha = 0
#temp
#eta = 0.5
# nrounds = seq(10,90,10)
xgplot_temp = data.table(x = c(seq(90,220,10)), y =c(
    4799.854, 4794.721, 4790.382, 4786.851, 4784.128, 4782.17, 4780.891,4780.172,4779.880, 4779.892, 4780.108,4780.453, 4780.876,4781.348
)) 
xgplot_temp_alpha_170 = data.table(x = c(0.5, 1, 3, 4,5,6, 8, 10, 15), y =c(
   4777.452, 4775.492, 4771.709, 4771.388, 4771.667, 4773.074, 4774.469, 4782.092, 4797.901
)) 
xgplot_temp_alpha_4 = data.table(x = c(seq(150,240,10), seq(300, 800, 100)), y =c(
   4772.381, 4771.860, 4771.388, 4771.087, 4770.901,4770.694,4770.528,4770.508, 4770.540,4770.540,
   4769.048, 4766.209, 4764.450, 4762.570, 4761.506, 4761.262
)) 

xgplot_temp_alpha_4.25 = data.table(x = c(seq(150,550,10), 600, 650, 700, 750,800, 810, 820,830,840,900, 1000), y =c(
   4772.376, 4771.802, 4771.310, 4771.029, 4770.808, 4770.654, 4770.561, 4770.484, 4770.466, 4770.334, 4770.097, 4769.829,4769.567, 4769.286,4769.136, 4768.843,4768.524, 4768.232, 4768.170, 4767.76, 4767.485, 4767.199, 4766.918, 4766.662, 4766.434,4766.245, 4766.051,4765.876, 4765.681, 4765.487, 4765.338, 4765.155, 4764.936, 4764.718,4764.544, 4764.328,4764.122,4763.959,4763.779,4763.610, 4763.407, 4762.411,4761.891, 4761.563, 4761.362,4761.204, 
   4761.184,
   4761.174,
   4761.192,
   4761.237,4761.596,4762.295
)) 

xgplot_temp_alpha_5 = data.table(x = c(seq(300, 800, 100), 850, 900), y =c(4768.714, 4766.399, 4764.511,4762.607,
    4761.636, 4761.316, 4761.421, 4761.726, 
)) 


xgplot_factor_alpha_4 = data.table(x = c(2, 2.5, 2.75,3, 3.25,3.5, 4,4.25, 4.5, 5), 
                                  y =c(4773.261, 4772.181, 4771.319, 4770.808,4770.591,4770.508, 4770.484, 4770.461, 4770.484,4770.550, 4771.076
)) 
#Best at M = 220, alpha = 4, 4770.461






########## Interaction 5-years 

#Find M
xgb_plot_inter_alpha0 = data.table(x = c(seq(10,120,10)), y =c(2813.145, 2673.747,2622.907, 2601.973,2589.755, 2581.725,2576.303,2572.637, 2570.267, 2568.548, 2569.051, 2569.821)) 

#100 at 2568.548

#Find alpha
xgb_plot_inter_M_100 = data.table(x = c(seq(2,8,0.5)), y =c(2564.693, 2567.632, 2572.003,2577.510,2584.147, 2591.169,2598.278, 2605.406,2612.711, 2620.088,2628.169,2636.800,2645.783, 2655.269)) 
#Best at alpha=2

#Grid
xgb_plot_inter_M_100_alpha_2 = data.table(x = c(seq(110,200,10)),  y=c(2562.308,2560.768,2559.841,2559.501,2559.449,2559.558,2559.768,2560.139, 2560.697, 2561.156)) 


xgb_plot_inter_M_100_alpha_1.5 = data.table(x = c(seq(100,200,10)),  y=c(2563.259, 2561.177,2559.875, 2559.189, 2558.929, 2558.977, 2559.256, 2559.626, 2560.106, 2560.673, 2561.218))

xgb_plot_inter_M_100_alpha_1.75 = data.table(x = c(seq(110,200,10)),  y=c(2561.513,2560.008, 2559.240,2558.963, 2558.922,2559.108,2559.424, 2559.895, 2560.403,2560.912)) 


xgb_plot_inter_M_100_alpha_1.9 = data.table(x = c(seq(100,190,10)),  y=c(2564.320,2561.909,  2560.424,2559.562, 2559.185, 2559.133, 2559.319, 2559.626, 2560.021, 2560.431)) 


xgb_plot_inter_M_100_alpha_2 = data.table(x = c(seq(110,200,10)),  y=c(2562.308,2560.768,2559.841,2559.501,2559.449,2559.558,2559.768,2560.139, 2560.697, 2561.156)) 


xgb_plot_inter_M_100_alpha_2.1 = data.table(x = c(seq(100,190,10)),  y=c(2565.154, 2562.720, 2561.179,2560.294, 2559.971,2559.830, 2559.832 , 2560.024, 2560.406,  2560.838)) 


xgb_plot_inter_M_100_alpha_2.25 = data.table(x = c(seq(110,200,10)),  y=c(2563.500,2561.980,2561.102,2560.668,2560.453,  2560.389,  2560.568,2560.907, 2561.282, 2561.735)) 

xgb_plot_inter_M_100_alpha_3 = data.table(x = c(seq(100,240,20)),  y=c(2572.003, 2567.560, 2565.680, 2565.130,2565.143,2565.703,2566.626, 2567.409)) 

#Now trying eta = 0.3 for slightly higher 

xgb_plot_inter_M_100_alpha_2 = data.table(x = c(seq(200,1000,100)),  y=c(2563.141, 2561.665, 2561.098, 2560.460, 2560.188,2560.268, 2560.370, 2560.429, 2560.758 )) 

plot(xgb_plot_inter_M_100_alpha_1.5, type = 'l', ylim = c(2557, 2568))
lines(xgb_plot_inter_M_100_alpha_3$x, xgb_plot_inter_M_100_alpha_3$y, col = 2)
lines(xgb_plot_inter_M_100_alpha_1.75$x, xgb_plot_inter_M_100_alpha_1.75$y, col = 3)
lines(xgb_plot_inter_M_100_alpha_2.25$x, xgb_plot_inter_M_100_alpha_2.25$y, col = 4)
lines(xgb_plot_inter_M_100_alpha_2$x, xgb_plot_inter_M_100_alpha_2$y, col = 5)
lines(xgb_plot_inter_M_100_alpha_1.9$x, xgb_plot_inter_M_100_alpha_1.9$y, col = 6)
```
Riccardo:
1) Try ridge penalty on GamFl2. 
2) after finding a good lambda, expect the loss to drop over many m's. 

```{r}
# temp model 
xgb_plot_temp = data.table(x = c(seq(1,9,1),seq(11,19,1),seq(10,150,10)), y =c(5379.419,5364.76,5318.158, 5230.371, 5223.17,5184.36, 5187.322, 5184.764, 5178.919,           5178.565,  5202.314, 5191.432,5198.115, 5208.381, 5211.138, 5229.498,  5217.52, 5215.932,  5223.368,   5218.326, 5255.646, 5286.704,5321.16,5340.85,5352.132,5374.445,5408.779, 5453.534,5475.457,5493.994,5520.439, 5543.879, 5563.307))

#Factor model 
xgplot = data.table(x = c(seq(50,150,10), seq(110,130,2), seq(111,129,2)), y = c(2758.416, 2731.099,2726.698, 2714.088, 2709.586, 2702.680,  2702.089, 2694.412, 2699.621,2716.644,2720.517, 2702.089, 2701.79, 2698.499, 2698.558,  2694.426, 2694.412, 2699.946, 2695.869,2698.616,2699.452,2699.621,     2705.609, 2700.882, 2693.071, 2696.202, 2698.113, 2697.815 ,2700.821,2697.841, 2698.301,2699.779))

#Interaction model 
xgb_plot_inter= data.table(x = c(seq(50,210,10)), y =c(4378.800, 4296.207,4197.691,4119.729,4055.193, 3979.32, 3913.073,3865.859, 3799.318,3763.141,3723.93,3688.609,3666.719, 3636.711,  3619.922,3615.032, 3590.712)) 

#Alpha = 0 
xgb_plot_inter= data.table(x = c(seq(20,90,10), seq(31,35,1), seq(25,29,1)), y =c(
    2576.358,2563.916,2563.995,2564.594,2564.782,2564.854,2565.078,2565.529,2563.746,2563.651,2563.610,2563.617,2563.642, 2566.678,  2565.765,2565.061, 2564.551 ,2564.17
)) 

#m = 33
xgb_plot_alpha_33= data.table(x = c(c(0.1, 0.5, 1, 5, 10, 50, 100), c(3:13)), y =c(
    2562.905, 2560.266, 2557.275, 2545.222, 2545.89, 2829.408, 3445.039, 
    2548.808,
    2546.512,
    2545.222,
    2544.434,
    2544.033,
    2544.147,
    2544.744,
    2545.890,
    2547.943,
    2550.036,
    2552.383
))
# alpha = 7

```

