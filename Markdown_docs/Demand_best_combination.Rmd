---
title: "Demand - Best Combination"
author: "Eirik Sj√•vik"
date: "2023-03-02"
output: html_document
---

In this document we are looking at:
1) the best combination of time covariates model, both interaction and no interaction 
2) the best combination of Factor loading  model
3) the best overall combination


The results show 2 types of sensitivity to time interval
1) The Factor10_3 2FL model is not the best any more if we cut away the 2016-17. It is doing better later. 
2) The Climatology is also doing horribly the first two years, with performance stabilizing after 3 years. 
3) No question that we are doing better than climatology, but not as much. 

4) Even if PC2 does not contribute much alone, it does contribute when the model increases. 
5) Classic case of overfitting whit more than 2 PC components. 


Some BLAS problems 
Inter1$Result[pred_1<70000&pred_1>10000,sqrt(mean((volume - pred_1)^2))]
Because of problems with overflow. 

# 1) Load Models
```{r , include=FALSE}
library(DemandForecast)
library(data.table)
path = '/Users/Eirik/Desktop/Master2023/Output_data/output_demand_forecast_best_baseline/'
load(paste0(path, 'Year1.Rda'))
load(paste0(path, 'Climatology.Rda'))
load(paste0(path, 'Naive.Rda'))
load(paste0(path, 'No_inter_1.Rda'))
load(paste0(path, 'No_inter_2.Rda'))
load(paste0(path, 'No_inter_3.Rda'))
load(paste0(path, 'No_inter_4.Rda'))
load(paste0(path, 'No_inter_5.Rda'))
load(paste0(path, 'No_inter_6.Rda'))
load(paste0(path, 'No_inter_7.Rda'))
load(paste0(path, 'No_inter_8.Rda'))
load(paste0(path, 'Inter1.Rda'))
load(paste0(path, 'Inter2.Rda'))
load(paste0(path, 'Inter3.Rda'))
load(paste0(path, 'Inter4.Rda'))
load(paste0(path, 'Custom1.Rda'))
load(paste0(path, 'Custom2.Rda'))
load(paste0(path, 'Custom3.Rda'))
load(paste0(path, 'Custom4.Rda'))
load(paste0(path, 'Custom5.Rda'))
load(paste0(path, 'Custom6.Rda'))
load(paste0(path, 'Custom7.Rda'))
load(paste0(path, 'Custom8.Rda'))
load(paste0(path, 'Custom9.Rda'))
load(paste0(path, 'Custom10.Rda'))

load(paste0(path, 'Custom_lin1.Rda'))
load(paste0(path, 'Custom_lin2.Rda'))
load(paste0(path, 'Custom_lin3.Rda'))
load(paste0(path, 'Custom_lin4.Rda'))
load(paste0(path, 'Custom_lin5.Rda'))
load(paste0(path, 'Custom_lin6.Rda'))
load(paste0(path, 'Custom_lin7.Rda'))
load(paste0(path, 'Custom_lin8.Rda'))
load(paste0(path, 'Custom_lin9.Rda'))
load(paste0(path, 'Custom_lin10.Rda'))

load(paste0(path, 'Custom_comb1.Rda'))
load(paste0(path, 'Custom_comb2.Rda'))
load(paste0(path, 'Custom_comb3.Rda'))
load(paste0(path, 'Custom_comb4.Rda'))
load(paste0(path, 'Custom_comb5.Rda'))
load(paste0(path, 'Custom_comb6.Rda'))
load(paste0(path, 'Custom_comb7.Rda'))
load(paste0(path, 'Custom_comb8.Rda'))
load(paste0(path, 'Custom_comb9.Rda'))
load(paste0(path, 'Custom_comb10.Rda'))

load(paste0(path, 'Mean_temp1.Rda'))
load(paste0(path, 'Mean_temp2.Rda'))

load(paste0(path, 'Factor10_inter1.Rda'))
load(paste0(path, 'Factor10_inter2.Rda'))
load(paste0(path, 'Factor10_inter3.Rda'))
load(paste0(path, 'Factor10_inter4.Rda'))

load(paste0(path,"Custom_comb3_int.Rda"))
load(paste0(path,"Custom_comb4_int.Rda"))
load(paste0(path,"Custom_comb5_int.Rda"))
load(paste0(path,"Custom_comb6_int.Rda"))
load(paste0(path,"Custom_comb7_int.Rda"))
load(paste0(path,"Custom_comb8_int.Rda"))
load(paste0(path,"Custom_comb9_int.Rda"))
load(paste0(path,"Custom_comb10_int.Rda"))

load(paste0(path,"Custom_comb10_int_m_w.Rda"))
load(paste0(path,"Custom_comb9_int_m_w.Rda"))
load(paste0(path,"Custom_comb8_int_m_w.Rda"))
load(paste0(path,"Custom_comb7_int_m_w.Rda"))
load(paste0(path,"Custom_comb6_int_m_w.Rda"))
load(paste0(path,"Custom_comb5_int_m_w.Rda"))
load(paste0(path,"Custom_comb4_int_m_w.Rda"))
load(paste0(path,"Custom_comb3_int_m_w.Rda"))
load(paste0(path,"Custom_comb10_int_w_m.Rda"))
load(paste0(path,"Custom_comb9_int_w_m.Rda"))
load(paste0(path,"Custom_comb8_int_w_m.Rda"))
load(paste0(path,"Custom_comb7_int_w_m.Rda"))
load(paste0(path,"Custom_comb6_int_w_m.Rda"))
load(paste0(path,"Custom_comb5_int_w_m.Rda"))
load(paste0(path,"Custom_comb4_int_w_m.Rda"))
load(paste0(path,"Custom_comb3_int_w_m.Rda"))
load(paste0(path,"Custom_comb10_int_m_m.Rda"))
load(paste0(path,"Custom_comb9_int_m_m.Rda"))
load(paste0(path,"Custom_comb8_int_m_m.Rda"))
load(paste0(path,"Custom_comb7_int_m_m.Rda"))
load(paste0(path,"Custom_comb6_int_m_m.Rda"))
load(paste0(path,"Custom_comb5_int_m_m.Rda"))
load(paste0(path,"Custom_comb4_int_m_m.Rda"))
load(paste0(path,"Custom_comb3_int_m_m.Rda"))
load(paste0(path,"mean_m_w.Rda"))
load(paste0(path,"mean_w_w.Rda"))
load(paste0(path,"mean_w_m.Rda"))
load(paste0(path,"mean_m_m.Rda"))

```


# 2) Naive combination model 
```{r, eval = FALSE}
Naive= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                        p_comps = 0,  reg_form = "volume ~ hour + season + w_day + week + month + year")
```

# 3) Best model no interaction
```{r, eval = FALSE}
No_inter_1= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + month1 + month2 + season1 + season2 + year")

No_inter_2= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ s(hour)  + as.factor(w_day) + s(week) + month1 + month2 + season1 + season2 + year")

No_inter_3= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + as.factor(week) + month1 + month2 + season1 + season2 + year")

No_inter_4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + s(month) + season1 + season2 + year", incl_climatology = TRUE)

No_inter_5= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + month1 + month2 + as.factor(season1)+ year")

##############
No_inter_6= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ s(hour)  + as.factor(w_day) + s(week) + s(month) + season1 + season2 + year")

No_inter_7= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + as.factor(week) +s(month) + season1 + season2 + year")

No_inter_8= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour)  + as.factor(w_day) + s(week) + s(month) + as.factor(season1)+ year")
```


```{r, cache = TRUE}
plot(No_inter_1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700))
lines(No_inter_2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], col = 'red')
lines(No_inter_5$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_6$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_5$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(No_inter_7$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(No_inter_1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700))
lines(No_inter_2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], col = 'red')
lines(No_inter_5$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_6$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_7$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(No_inter_8$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
No_inter_1$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_2$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_3$Result[,sqrt(mean((volume - pred_1)^2))], 
No_inter_4$Result[,sqrt(mean((volume - pred_1)^2))], #Best s(month)
No_inter_5$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_6$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_7$Result[,sqrt(mean((volume - pred_1)^2))],
No_inter_8$Result[,sqrt(mean((volume - pred_1)^2))],
Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```

# 4) Interaction models
```{r, eval = FALSE}
Inter1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, 
                         train_y = 5, p_comps = 0,  
                         reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year")

Inter2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year")

Inter3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year") #Have run

Inter4 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 0,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year") #Have run
```


```{r, cache = TRUE}
plot(Inter1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700))
lines(Inter2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Inter3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Inter4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], col = 'red')

lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Inter1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700))
lines(Inter2$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Inter3$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Inter4$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], col = 'red')

lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Inter1$Result[pred_1<70000&pred_1>10000,sqrt(mean((volume - pred_1)^2))],
#Inter1$Result[,sqrt(mean((volume - pred_1)^2))],
Inter2$Result[,sqrt(mean((volume - pred_1)^2))] ,
Inter3$Result[,sqrt(mean((volume - pred_1)^2))], 
Inter4$Result[,sqrt(mean((volume - pred_1)^2))], #Best s(month)

Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```




# 5a) Single Factor loading models (splines)
```{r, eval = FALSE}
Custom1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 's(PC1)',  reg_form = "volume ~ 1", cores =48)
Custom2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 2, custom = 's(PC2)',  reg_form = "volume ~ 1", cores =48)
Custom3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 3, custom = 's(PC3)',  reg_form = "volume ~ 1", cores =48)
Custom4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps =4, custom = 's(PC4)',  reg_form = "volume ~ 1", cores =48)
Custom5 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 5, custom = 's(PC5)',  reg_form = "volume ~ 1", cores =48)
Custom6 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 6, custom = 's(PC6)',  reg_form = "volume ~ 1", cores =48)
Custom7 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 7, custom = 's(PC7)',  reg_form = "volume ~ 1", cores =48)
Custom8 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 8, custom = 's(PC8)',  reg_form = "volume ~ 1", cores =48)
Custom9 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 9, custom = 's(PC9)',  reg_form = "volume ~ 1", cores =48)
Custom10 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10, custom = 's(PC10)',  reg_form = "volume ~ 1", cores =48)
```


```{r, cache = TRUE}
plot(Custom1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

Custom1$Result[,sqrt(mean((volume - pred_2)^2))]
Custom2$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom3$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom4$Result[,sqrt(mean((volume - pred_2)^2))] #Best s(month)
Custom5$Result[,sqrt(mean((volume - pred_2)^2))]
Custom6$Result[,sqrt(mean((volume - pred_2)^2))]
Custom7$Result[,sqrt(mean((volume - pred_2)^2))]
Custom8$Result[,sqrt(mean((volume - pred_2)^2))]
Custom9$Result[,sqrt(mean((volume - pred_2)^2))]
Custom10$Result[,sqrt(mean((volume - pred_2)^2))]
Naive$Result[,sqrt(mean((volume - pred_1)^2))]
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```

# 5b) Single Factor loading models (linear)
```{r, eval  = FALSE}
Custom_lin1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 'PC1',  reg_form = "volume ~ 1", cores =48)
Custom_lin2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 2, custom = 'PC2',  reg_form = "volume ~ 1", cores =48)
Custom_lin3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 3, custom = 'PC3',  reg_form = "volume ~ 1", cores =48)
Custom_lin4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps =4, custom = 'PC4',  reg_form = "volume ~ 1", cores =48)
Custom_lin5 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 5, custom = 'PC5',  reg_form = "volume ~ 1", cores =48)
Custom_lin6 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 6, custom = 'PC6',  reg_form = "volume ~ 1", cores =48)
Custom_lin7 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 7, custom = 'PC7',  reg_form = "volume ~ 1", cores =48)
Custom_lin8 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 8, custom = 'PC8',  reg_form = "volume ~ 1", cores =48)
Custom_lin9 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 9, custom = 'PC9',  reg_form = "volume ~ 1", cores =48)
Custom_lin10 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10, custom = 'PC10',  reg_form = "volume ~ 1", cores =48)
```

```{r, cache = TRUE}
plot(Custom_lin1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_lin2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_lin10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_lin1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_lin2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_lin10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

Custom_lin1$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin2$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom_lin3$Result[,sqrt(mean((volume - pred_2)^2))] 
Custom_lin4$Result[,sqrt(mean((volume - pred_2)^2))] #Best s(month)
Custom_lin5$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin6$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin7$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin8$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin9$Result[,sqrt(mean((volume - pred_2)^2))]
Custom_lin10$Result[,sqrt(mean((volume - pred_2)^2))]
Naive$Result[,sqrt(mean((volume - pred_1)^2))]
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```



# 6) Mean temperature model 
```{r, eval=FALSE}
Mean_temp1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 'hourly_mean_grid',  reg_form = "volume ~ 1")

Mean_temp2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 1, custom = 's(hourly_mean_grid)',  reg_form = "volume ~ 1")
```

# 7a) Combinations of Increasing # of Factor loadings
```{r, eval=FALSE}
Custom_comb1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ 1", cores =48)
Custom_comb2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 2, custom = 's(PC1) + s(PC2)',  reg_form = "volume ~ 1", cores =48)
Custom_comb3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 3, custom = 's(PC1) + s(PC3)',  reg_form = "volume ~ 1", cores =48)
Custom_comb4= demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps =4, custom = 's(PC1) + s(PC4)',  reg_form = "volume ~ 1", cores =48)
Custom_comb5 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 5, custom = 's(PC1) + s(PC5)',  reg_form = "volume ~ 1", cores =48)
Custom_comb6 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 6, custom = 's(PC1) + s(PC6)',  reg_form = "volume ~ 1", cores =48)
Custom_comb7 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 7, custom = 's(PC1) + s(PC7)',  reg_form = "volume ~ 1", cores =48)
Custom_comb8 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 8, custom = 's(PC1) + s(PC8)',  reg_form = "volume ~ 1", cores =48)
Custom_comb9 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 9, custom = 's(PC1) + s(PC9)',  reg_form = "volume ~ 1", cores =48)
Custom_comb10 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10, custom = 's(PC1) + s(PC10)',  reg_form = "volume ~ 1", cores =48)
```





```{r, cache = TRUE}
plot(Custom_comb1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700))
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], col = 'red')
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_3)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_4)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_5)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_6)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_7)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_8)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_9)^2)), keyby = init_date])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_10)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date], col = 'blue')

plot(Custom_comb1$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700))
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], col = 'red')
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_3)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_4)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_5)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_6)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_7)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_8)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_9)^2)), keyby = month(init_date)])
lines(Custom_comb1$Result[,sqrt(mean((volume - pred_10)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)], col = 'blue')

print(c(
Custom_comb1$Result[,sqrt(mean((volume - pred_1)^2))], 
Custom_comb1$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb1$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_4)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_5)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_6)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_7)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_8)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_9)^2))],
Custom_comb1$Result[,sqrt(mean((volume - pred_10)^2))],
Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```
# 7b) Combinations of 2 Factor loadings
```{r, cache = TRUE}
plot(Custom_comb2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb2$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb4$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb2$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb3$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10$Result[,sqrt(mean((volume - pred_2)^2))],
Naive$Result[,sqrt(mean((volume - pred_1)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```

## Final 1 Best Demand Models (Increasing)

```{r, eval = FALSE}
Factor10_inter1 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year", cores = 48)

Factor10_inter2 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year", cores = 48) 

Factor10_inter3 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year", cores = 48) 

Factor10_inter4 = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01', pred_win = 30, pred_lag = 15, train_y = 5, 
                    p_comps = 10,  reg_form = "volume ~ as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year", cores = 48) #
```





```{r, cache=TRUE}
plot(Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(1600, 8000))
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2)), keyby = init_date], col = 'red')
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_4)^2)), keyby = init_date])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_5)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_6)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_7)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_8)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_9)^2)), keyby = init_date])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_10)^2)), keyby = init_date])

#lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date], col = 'blue')

plot(Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 6000))
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2)), keyby = month(init_date)], col = 'red')
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_4)^2)), keyby = month(init_date)])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_5)^2)), keyby = month(init_date)])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_6)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_7)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_8)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_9)^2)), keyby = month(init_date)])
#lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_10)^2)), keyby = month(init_date)])
#lines(Naive$Result[,sqrt(mean((volume - pred_1)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)], col = 'blue')

Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2))] #Best 
Factor10_inter3$Result[,sqrt(mean((volume - pred_4)^2))] 
Factor10_inter3$Result[,sqrt(mean((volume - pred_5)^2))] 
Factor10_inter3$Result[,sqrt(mean((volume - pred_6)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_7)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_8)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_9)^2))]
Factor10_inter3$Result[,sqrt(mean((volume - pred_10)^2))]
Naive$Result[,sqrt(mean((volume - pred_1)^2))]
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```

# Main plotting Function


## Final 2 Best Demand Model (Two models)
```{r}
for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_w_w"), mod)
}

for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_m_w"), mod)
}

for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_w_m"), mod)
}

for (i in 3:10){
    mod = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                          pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                          custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + 
                                          s(week) + s(month) + season1 + season2 + year + s(PC1)+ s(PC",i,")") ,
                          cores = 48, reg_form = "volume~1")
    assign(paste0("Custom_comb",i, "_int_m_m"), mod)
}
```

### Plot
```{r, cache = TRUE}
plot(Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```


```{r, cache = TRUE}
plot(Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```


```{r, cache = TRUE}
plot(Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date])

plot(Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 13700), col = 'red')
lines(Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)])

print(c(
Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
))
```


```{r}

w_w = c(
Inter1$Result[pred_1<70000&pred_1>10000,sqrt(mean((volume - pred_1)^2))],
Factor10_inter1$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter1$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))]
)


m_w = c(
Factor10_inter2$Result[,sqrt(mean((volume - pred_1)^2))],
Factor10_inter2$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter2$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_w$Result[pred_2 < 100000 & pred_2 > -100000,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_w$Result[,sqrt(mean((volume - pred_2)^2))]
)

w_m = c(
Factor10_inter3$Result[,sqrt(mean((volume - pred_1)^2))],
Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_w_m$Result[,sqrt(mean((volume - pred_2)^2))]
)

m_m = c(
Factor10_inter4$Result[,sqrt(mean((volume - pred_1)^2))],
Factor10_inter4$Result[,sqrt(mean((volume - pred_2)^2))],
Factor10_inter4$Result[,sqrt(mean((volume - pred_3)^2))],
Custom_comb3_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb4_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))], 
Custom_comb5_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb6_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb7_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb8_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb9_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))],
Custom_comb10_int_m_m$Result[,sqrt(mean((volume - pred_2)^2))]

)
pdf("/Users/Eirik/Desktop/Master2023/ExportedPlots/Best_final_demand2.pdf", height = 5, width = 7, pointsize = 12)
#layout(matrix(c(1,2,3,3), 2, 2, byrow = TRUE))
x = seq(1:length(m_m))-1
plot(x, w_m, type = 'l', cex.lab = 1.3, cex.main = 1.5, pch = 16, col = "red", main = "Test Error", ylab = "Test Error (RMSE)", xlab = "Factor Loadings in Model")  
points(x, w_m, pch = 16, col = "red")
lines(x, m_m, lty = 2, col = 'grey')
lines(x, m_w, lty = 2, col = 'grey')
lines(x, w_w, lty = 2, col = 'grey')
legend(leg_place, lty = 1, cex = 1, pch = 16, col = c('red', 'grey', 'blue'), legend = c("Test Errors", "Test Error (Alt Params)", "Test Errors (Increasing)"))
lines(x, Factor10_inter3$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'blue')
dev.off()
```


## Final 3 Best Demand Model (Mean Grid)
```{r}
mean_w_w = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                                      pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
cores = 48, reg_form = "volume~1")
save(mean_w_w, file = 'mean_w_w.Rda')

mean_w_m = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                           pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                           custom = paste0("as.factor(hour):as.factor(week)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
                           cores = 48, reg_form = "volume~1")
save(mean_w_m, file = 'mean_w_m.Rda')

mean_m_w = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                           pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                           custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(week) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
                           cores = 48, reg_form = "volume~1")
save(mean_m_w, file = 'mean_m_w.Rda')

mean_m_m = demand_forecast(X_mat, date_demand,forc_start = '2016-01-01', forc_end = '2023-01-01',
                           pred_win = 30, pred_lag = 15, train_y = 5, p_comps = i,  no_pc = TRUE,
                           custom = paste0("as.factor(hour):as.factor(month)  + as.factor(w_day):as.factor(month) + s(week) + s(month) + season1 + season2 + year + s(hourly_mean_grid)") ,
                           cores = 48, reg_form = "volume~1")
save(mean_m_m, file = 'mean_m_m.Rda')
```

```{r, cache=TRUE}
plot(mean_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], type = 'l', ylim = c(1600, 8000))
lines(mean_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date], col = 'red')
lines(mean_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(mean_w_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = init_date])
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = init_date], col = 'blue')

plot(mean_m_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], type = 'l', ylim = c(2000, 6000))
lines(mean_m_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], col = 'red')
lines(mean_w_m$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(mean_w_w$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)])
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_2)^2)), keyby = month(init_date)], col = 'purple')
lines(Factor10_inter3$Result[,sqrt(mean((volume - pred_3)^2)), keyby = month(init_date)], col = 'orange')
lines(Climatology$Result[,sqrt(mean((volume - clima_pred)^2)), keyby = month(init_date)], col = 'blue')

mean_m_m$Result[,sqrt(mean((volume - pred_2)^2))]
mean_m_w$Result[,sqrt(mean((volume - pred_2)^2))] 
mean_w_m$Result[,sqrt(mean((volume - pred_2)^2))] #Best 
mean_w_w$Result[,sqrt(mean((volume - pred_2)^2))] 
Climatology$Result[,sqrt(mean((volume - clima_pred)^2))]
```
#Numbers for  Factor10_1 are missing a month due to BLAS error. 
```{r, cache = TRUE}
Errorplot_factor_loading = function(data, plot_title = "Train and Test Error (2016-01:2023-01)", leg_place = 'topright', total_var = 11){
    
    test_pc = paste0('pred_', 1:total_var)
    train_pc = paste0('RMSE_train_', 1:total_var)
    test_plot = data[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc]
    #train_plot = data[, lapply(.SD, function(x) mean(x)), .SDcols = train_pc]
    Mrg = merge(Year1$Results[,.(date, hour, lead_time,N_train_1)], data, by = c("date", "hour", "lead_time"))

    train_plot = rep(NA, total_var)
    for (i in 1:total_var){
        vars = c("N_train_1", "lead_time", train_pc[i])
        Mrg_omit = na.omit(Mrg[,..vars])
        train_plot[i] = Mrg_omit[lead_time==361,sum(get(train_pc[i])*N_train_1, na.rm = FALSE)/ sum(N_train_1)]
    }
    #print(test_plot)
    x = seq(1:length(test_plot))-1
    
    
    par(mar=c(5,5,5,5))
    # Test plot
    plot(x, test_plot, type = 'l', cex.lab = 1.3, cex.main = 1.5, pch = 16, col = "red", main = paste(plot_title), ylab = "Test Error", xlab = "Number of Factor Loadings in Model")  
    points(x, test_plot, pch = 16, col = "red")
    lines(x, Factor10_inter2$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'grey')
    lines(x, Factor10_inter1$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'grey')
    lines(x, Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm=TRUE))), .SDcols = test_pc], lty = 2, col = 'grey')
    par(new = TRUE)         #new axis
    
    # Train plot
    plot(x, train_plot, type = 'l', cex.lab = 1.7, col = "black", axes = FALSE, xlab = "", ylab = "")
    points(x, train_plot, pch = 16, col = "black")
    
    axis(side = 4, at = pretty(range(train_plot)))      
    mtext("Train Error", side = 4, line = 3, cex = 1.3)
    legend(leg_place, lty = 1, cex = 1, pch = 16, col = c('red', 'black', 'grey'), legend = c("Test Errors", "Training Errors", "Test Error (Alt Params)"))
}

test_pc = paste0('pred_', 1:11)
train_pc = paste0('RMSE_train_', 1:11)
pdf("Best_final_demand.pdf", height = 5, width = 7, pointsize = 12)
Errorplot_factor_loading(Factor10_inter3$Results)
dev.off()

Errorplot_factor_loading(Factor10_inter3$Results[init_date>'2018-06-01',]) #Greys are not adjusted here


by_init =Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc, by = init_date]

#by_init[, lapply(.SD, function(x) mean(x)), .SDcols = test_pc]

Factor10_results = rbind(
Factor10_inter1$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2, na.rm = TRUE))), .SDcols = test_pc],
Factor10_inter2$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc],
Factor10_inter3$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc],
Factor10_inter4$Results[, lapply(.SD, function(x) sqrt(mean((volume - x)^2))), .SDcols = test_pc]
)

print(t(Factor10_results))

#Factor10_inter1_real[, lapply(.SD, function(x) sqrt(mean((volume - x)^2,na.rm = TRUE))), .SDcols = test_pc]


###################################
#Skill by month

pdf("/Users/Eirik/Desktop/Master2023/ExportedPlots/GAM_FL2_3_skill_demand2.pdf", height = 7, width = 7, pointsize = 12)
layout(matrix(c(1,2,3,3), 2, 2, byrow = TRUE))
par(mar = c(4, 4, 4, 4))
plot(1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = month(date)][,V1]/
              Climatology$Results[, mean((volume - clima_pred)^2), keyby = month(date)][,V1]),
     type = 'l', ylim = c(-0.5, 1), xlab = 'Month', ylab = '', xaxt ='n',
     main = 'Skill of GAM-FL2 by Month', col = 'blue')


legend('top', cex = 0.7, pch = 16, col = c('blue','orange', 'black'), lty = c(1,2,1), title = 'Skill of GAM-FL2 relative to:', legend = c("Climatology", "Time Interaction", "GAM-FL1"))
abline(h = 0, col = 'black')
lines(1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = month(date)][,V1]/
               Inter4$Result[, mean((volume - pred_1)^2), keyby = month(date)][,V1]), col = rgb(1,0.5,0,0.65), lty = 2)
lines(1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = month(date)][,V1]/
               Factor10_inter3$Result[, mean((volume - pred_2)^2), keyby = month(date)][,V1]), col = 'black')
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = month][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
mtext("Skill Score", side = 2, line = 3, cex = 0.8, padj = 1.4)
ticks <- seq_len(12)
#axis(side = 1, at = ticks - 0.5, labels = FALSE)
axis(month.abb, side = 1, labels = month.abb, at = 1:12)
#By hour
plot(1:24,1 - (Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = hour][,V1]/
              Climatology$Results[, mean((volume - clima_pred)^2), keyby = hour][,V1]),
     type = 'l', ylim = c(-0.5, 1), xlab = 'Hour', ylab = '',xaxt = 'n',yaxt = 'n',
     main = 'Skill by Hour', col ='red')
abline(h = 0, col = 'black')
axis(1, at = c(1,6,12,18,24))
axis(side = 1, at = seq(1:24), labels = rep('', 24), tcl = 0.1)
lines(1:24,1 - (Factor10_inter3$Results[,  mean((volume - pred_2)^2), keyby = hour][,V1]/
               Climatology$Results[, mean((volume - clima_pred)^2), keyby = hour][,V1]),col = 'black')
lines(1:24,1 - (Factor10_inter3$Results[,  sqrt(mean((volume - pred_1)^2)), keyby = hour][,V1]/
               Climatology$Results[, sqrt(mean((volume - clima_pred)^2)), keyby = hour][,V1])^2,col = rgb(1,0.5,0,0.65), lty = 2)

legend('topright', lty = c(1,1,2), cex = 0.7, pch = 16, col = c('black', 'red', 'orange'), title = 'Skill relative to Climatology of:', legend = c("GAM-FL1", "GAM-FL2", "Time Interaction"))
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = hour][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
axis(side = 4, at = pretty(range(0, 4000)))      
    mtext("RMSE", side = 4, line = 3, cex = 0.8, padj = -1.4)

#Skill by init month
dates = unique(Factor10_inter3$Results$init_date)
plot(1:length(unique(Factor10_inter3$Results$init_date)),1 - (Factor10_inter3$Results[, mean((volume - pred_3)^2), keyby = init_date][,V1]/
              Climatology$Results[, mean((volume - clima_pred)^2), keyby = init_date][,V1]),
     type = 'l', ylim = c(-1.7, 1), xlab = 'Initialization Month', ylab = '',xaxt = 'n',
     main = 'Skill by Initialization Month', col = 'red')
axis(1, at = seq(1,length(dates), by = 6),labels = format(dates[seq(1, length(dates), by = 6)], "%b-%y"))
axis(side = 1, at = seq(1:85), labels = rep('', 85), tcl = 0.1)
abline(h = 0)

lines(1:length(unique(Factor10_inter3$Results$init_date)),1 - (Factor10_inter3$Results[,  sqrt(mean((volume - pred_2)^2)), keyby = init_date][,V1]/
               Climatology$Results[, sqrt(mean((volume - clima_pred)^2)), keyby = init_date][,V1])^2,col = 'black')

lines(1:length(unique(Factor10_inter3$Results$init_date)),1 - (Factor10_inter3$Results[,  sqrt(mean((volume - pred_1)^2)), keyby = init_date][,V1]/
               Climatology$Results[, sqrt(mean((volume - clima_pred)^2)), keyby = init_date][,V1])^2,col = rgb(1,0.5,0,0.65), lty = 2)
legend('left', lty = c(1,1,2), cex = 0.7, pch = 16, col = c('black', 'red', 'orange'), title = 'Skill relative to Climatology of:', legend = c("GAM-FL1", "GAM-FL2", "Interaction"))
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = init_date][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
axis(side = 4, at = pretty(range(0, 10000)))      
mtext("RMSE", side = 4, line = 3, cex = 0.8, padj = -1.4)
mtext("Skill Score", side = 2, line = 3, cex = 0.8, padj = 1.4)

dev.off()

#####################

#Skill by month after 2018
plot(month.abb,1 - (Factor10_inter3$Results[init_date>'2018-03-01',  sqrt(mean((volume - pred_3)^2)), keyby = month(date)][,V1]/
              Climatology$Results[init_date>'2018-03-01', sqrt(mean((volume - clima_pred)^2)), keyby = month(date)][,V1])^2,
     type = 'l', ylim = c(0, 0.8), xlab = 'Month', ylab = 'Skill Score',
     main = 'Skill of GAMFL2 by Month')
axis(month.abb, side = 4, labels = month.abb, at = 1:12)
legend('topright', lty = 1, cex = 1, pch = 16, col = c('black','red'), title = 'Skill relative to:', legend = c("Climatology", "Time Interaction"))

lines(1 - (Factor10_inter3$Results[init_date>'2018-03-01',  sqrt(mean((volume - pred_3)^2)), keyby = month(date)][,V1]/
               Inter4$Result[init_date>'2018-03-01', sqrt(mean((volume - pred_1)^2)), keyby = month(date)][,V1])^2, col = 'red')

plot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = lead_time], type = 'l', main = "RMSE by lead time", ylab = "RMSE", xlab = "Lead Time")
lin_mod = lm(V1 ~ lead_time, data = Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = lead_time])
lines(361:1080, predict(lin_mod))
abline(h = coef(lin_mod)[1])
#Mrg[lead_time==361, sum(RMSE_train_3*N_train_1)/ sum(N_train_1)]d
```




```{r, cache=TRUE}
acf(Factor10_inter3$Result[,volume -pred_2])
```



# Compare combination Models
```{r, cache=TRUE}

plot(Factor10_inter3$Result[,volume])
lines(Factor10_inter3$Result[,volume], col = 'red')

plot(Factor10_inter3$Result[year(date) ==yr & month %in% c(4,5) & hour %in% c(6,12,18,24),volume], cex = 0.4)
#lines(Baseline_old$Result[year(date) ==2019& month ==3,pred_1], col = 'blue')
lines(Climatology$Result[year(date) ==yr& month %in% c(4,5)& hour %in% c(6,12,18,24),clima_pred], col = 'blue')
#lines(Best$Result[year(date) ==2019& month ==3,pred_2], col = 'red', lty = 2)
lines(Factor10_inter3$Result[year(date) ==yr& month %in% c(4,5)& hour %in% c(6,12,18,24),pred_3], col = 'red')

#lines(Naive$Result[year(date) ==2019& month ==3,pred_1], col = 'yellow', lty = 2)

plot(Factor10_inter3$Result[year(date) ==yr,volume -pred_3], col = 'purple', type = 'l')
acf(Factor10_inter3$Result[year(date) ==yr,volume -pred_3])
acf(Factor10_inter3$Result[,volume -pred_3])
```

# Make a temperature plot with 
1) Loss for all years
1) Compare temp for 2016 against mean temp over all year per hour, day
2) Compare predictions from baseline model and best model for 2016
3) Compare volume for that year


Skill by month
Show difference to pure climatology model. 

jensens inequality read up

Instead of doing the squared error directly

we sum the predictions for each day and compared for summed volume. 

the other version has a rational for stake holders


```{r}
plot(1:85, 1 - Factor10_inter3$Results[,  mean((volume - pred_3)^2), keyby = init_date][,V1]/
         Climatology$Results[, mean((volume - clima_pred)^2), keyby =init_date][,V1],
     type = 'l', ylim = c(-2.5, 1), xlab = "", ylab = "", xaxt = 'n')
par(new = TRUE)
barplot(Factor10_inter3$Results[,  sqrt(mean((volume - pred_3)^2)), keyby = init_date][,V1], ylim = c(0, 10000), col = rgb(0,0,1, 0.1),xlab = "", ylab = "", xaxt = 'n', axes = FALSE)
```



```{r, cache = TRUE}
if(file.exists("~/Desktop/Master2023/Data/")){
    prep = prep_demand_temp_data(include_na_volume = FALSE, 
                          path = "~/Desktop/Master2023/Data/")
}else{
    prep = prep_demand_temp_data(include_na_volume = FALSE)
}
#
X_mat = prep$X_mat #Temperature field
date_demand = prep$date_demand
X_mean = rowMeans(X_mat) - 273.15
date_demand[, grid_mean_temp:= X_mean]
date_demand[, climatology:= mean(grid_mean_temp), by = .(hour, yday(date))]
date_demand[, climat_volume:= mean(volume), by = .(hour, week(date))]
#(lat 4-25, long 55-75), 
pdf("/Users/Eirik/Desktop/Master2023/ExportedPlots/Pred_vs_actual_4_demand.pdf", height = 7, width = 9, pointsize = 12)
layout(matrix(c(1,2,3,4), 2, 2, byrow = TRUE))
par(mar = c(3.4, 3.2, 2, 3.2))

yr = 2021
#PLOT 1: Daily skill level one year
plot(1 - Factor10_inter3$Results[year(date)==yr,  mean((volume - pred_3)^2), keyby = week(date)][,V1]/
              Climatology$Results[year(date)==yr, mean((volume - clima_pred)^2), keyby = week(date)][,V1],
     type = 'l', ylim = c(-0.8, 1), xlab = "", ylab = "", xaxt = 'n',
     main = paste0('Skill of GAM-FL2 by Week (', yr,')'))
abline(h = 0, col = 'black')
rect(9.5, -7, 10.5, par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
rect(48.5, -7, 49.5, par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
axis(1, at = c(1, 10, 19, 27, 36, 45, 53), labels = c(format(Factor10_inter3$Results[year(date)==yr,  .(date,mean((volume - pred_3)^2)), keyby = week(date)][, .(date= date[1]), by = V2][c(1, 10, 19, 27, 36, 45),date],  "%b"), 'Jan'))
legend('bottomleft', lty = c(1,2), cex = 0.7, col = c('black','orange'), title = 'Skill relative to:', legend = c("Climatology", "Time Interaction"),bg = "white")
lines(1 - (Factor10_inter3$Results[year(date)==yr,  mean((volume - pred_3)^2), keyby = week(date)][,V1]/
               Inter4$Result[year(date)==yr, mean((volume - pred_1)^2), keyby = week(date)][,V1]), col = 'orange', lty = 2)
mtext(paste0('Month (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)
mtext('Skill Score', side = 2, line = 3, cex = 0.8, padj = 1.4)
mtext('Week 10', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.25)
mtext('Week 49', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.85)

#PLOT 2: Daily Mean Grid Temp
plot(date_demand[year(date)==yr & hour %in%12,.(date, climatology)], type = 'l', 
     ylim = c(-13, 17), ylab = '', xlab = "", main = paste0('Temperature vs Demand at 12:00 (', yr,')'))
lines(date_demand[year(date)==yr & hour %in%12,.(date, grid_mean_temp)], col = 'red')

rect(as.Date('2021-02-25'), par("usr")[3], as.Date('2021-03-03'), par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
rect(as.Date('2021-12-02'), par("usr")[3], as.Date('2021-12-09'), par("usr")[4], col = rgb(0.5, 0.5, 0.5, alpha = 0.2), border = NA, lty = 0)
legend('bottomleft', lty = 1, cex = 0.7, col = c('green', 'blue'), legend = c(paste0("Observed (",yr,")"),"Climatology (2013-23)"), title = 'Daily Mean Grid Temperature:',bg = "white")
legend('bottomright', lty = 1, cex = 0.7, col = c('red', 'black'), legend = c(paste0("Observed (",yr,")"),"Climatology (2013-23)"), title = 'Weekly Mean Demand:',bg = "white")
par(new=TRUE)
plot(date_demand[year(date)==yr & hour %in%12,.(date,mean(volume)), keyby = week(date)][,.(date,V2)], type = 'l', cex.lab = 1.7, col = "green", axes = FALSE, xlab = "", ylab = "", ylim = c(32000, 62500))
axis(side = 4, at = pretty(range(date_demand[year(date)==yr & hour %in%12,.(date, volume)][,volume]))) 
lines(date_demand[year(date)==yr & hour %in%12,.(date, climat_volume)], col = 'blue')
mtext('Temperature (¬∞C)', side = 2, line = 3, cex = 0.8, padj = 1.4)
mtext("Energy Demand Volume (MWh)", side = 4, line = 3, cex = 0.8, padj = -1.4)
mtext(paste0('Month (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)

mtext('Week 10', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.23)
mtext('Week 49', side = 3, line = 4, cex = 0.8, padj = 10.4, adj = 0.865)

#par(new=TRUE)
#plot(Factor10_inter3$Results[year(date)==yr & hour %in%12,PC1], col = 'purple', type = 'l', axes = FALSE, xlab = "", ylab = "")

#PLOT 3: Predicted vs Actual
ww1 = 10
plot(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,volume], col = 'black', ylim = c(32000, 62500), pch = 16, cex= 0.6,xlab = "", main = paste0('Predicted vs Actual - Week ',  ww1, ' (', yr, ')'), xaxt = 'n', ylab = '')
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,pred_3], col = 'red')
lines(Climatology$Results[year(date) == yr & week(date) == ww1,clima_pred], col = 'blue', lty = 1)
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,pred_1], col = 'orange', lty = 2)
#lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,pred_2], col = 'pink', lty = 1)
legend('bottomleft', lty = 1, cex = 0.7, col = c('red', 'blue', 'orange'), legend = c('GAM-FL2',"Climatology", 'Time Interaction'), title = 'Model:')
axis(1, at = c(seq(1,168, by = 24), 168), labels = c(format(Factor10_inter3$Results[year(date) == yr & week(date) == ww1,date][seq(1,168, by = 24)], "%d-%b"), '11-Mar'))
mtext(paste0('Date (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)
mtext('Energy Demand Volume (MWh)', side = 2, line = 3, cex = 0.8, padj = 1.4)

#PLOT 4: Predicted vs Actual
ww2 = 49
plot(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,volume], col = 'black', ylim = c(32000, 62500), pch = 16, cex= 0.6,xlab = "", main = paste0('Predicted vs Actual - Week ',  ww2, ' (', yr, ')'), xaxt = 'n', ylab = '')
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,pred_3], col = 'red')
lines(Climatology$Results[year(date) == yr & week(date) == ww2,clima_pred], col = 'blue', lty = 1)
lines(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,pred_1], col = 'orange', lty = 2)
legend('bottomleft', lty = 1, cex = 0.7, col = c('red', 'blue', 'orange'), legend = c('GAM-FL2',"Climatology", 'Time Interaction'), title = 'Model:')
axis(1, at = c(seq(1,168, by = 24), 168), labels = c(format(Factor10_inter3$Results[year(date) == yr & week(date) == ww2,date][seq(1,168, by = 24)], "%d-%b"), '09-Dec'))
mtext(paste0('Date (',yr,')'), side = 1, line = 3, cex = 0.8, padj = -1.4)
mtext('Energy Demand Volume (MWh)', side = 2, line = 3, cex = 0.8, padj = 1.4)
dev.off()

######################

plot(date_demand[year(date)==yr & hour %in%12 & month == 3,.(date, climatology)], type = 'l', 
     ylim = c(-9, 16), ylab = 'Temperature (¬∞C)', xlab = 'Date', main = 'Daily Mean Grid Temperature at 12:00 (lat 4-25, long 55-75)')
lines(date_demand[year(date)==yr & hour %in%12& month == 3,.(date, grid_mean_temp)], col = 'red')
legend('bottomright', lty = 1, cex = 0.7, col = c('red', 'black'), legend = c(paste0(yr, " observed"),"Climatology"), title = 'Temperature')


date_demand[, climatology:= mean(grid_mean_temp), by = .(yday(date))]
date_demand[, mm_temp:= mean(grid_mean_temp), by = date]
plot(date_demand[year(date)==2022,.(date, mm_temp)], type = 'l', ylim = c(-8.7, 17))
lines(date_demand[year(date)==2022,.(date, climatology)], col = 'red')

date_demand[, mean_vol:= mean(volume), by = date]







plot(date_demand[year(date)==yr &  wday(date)  %in% c(1) &hour %in%12,volume, keyby = date], col = 'black', ylim = c(30000, 65000), pch = 16, cex= 0.6, type = 'l')

#Reason for including weekday-term 
hour_x = 24
plot(date_demand[year(date)==yr &  wday(date)  %in% c(1) &hour %in%hour_x,volume, keyby = date], col = 'black', ylim = c(25000, 65000), pch = 16, cex= 0.6, type = 'l', main = paste0('Difference between weekdays at ', hour_x, ':00.Rda'))
for (i in 2:7){
    lines(date_demand[year(date)==yr &  wday(date)  %in% c(i) &hour %in%hour_x,volume, keyby = date], col = i)
}

# "2014-02-15" "2014-04-15" "2014-06-15" "2014-08-15"
# "2014-09-15" "2014-11-15" "2015-01-15" "2015-02-15" "2015-04-15" "2015-06-15"
# "2015-08-15" "2015-09-15" "2015-11-15" "2016-01-15" "2016-02-15" "2016-04-15"
# "2016-06-15" "2016-08-15" "2016-09-15" "2016-11-15" "2017-01-15" "2017-02-15"
# "2017-04-15" "2017-06-15" "2017-08-15" "2017-09-15" "2017-11-15" "2018-01-15"
# "2018-02-15" "2018-04-15" "2018-06-15" "2018-08-15" "2018-09-15" "2018-11-15"
# "2019-01-15" "2019-02-15" "2019-04-15" "2019-06-15" "2019-08-15" "2019-09-15"
# "2019-11-15" "2020-01-15" "2020-02-15" "2020-04-15" "2020-06-15" "2020-08-15"
# "2020-09-15" "2020-11-15" "2021-01-15" "2021-02-15" "2021-04-15" "2021-06-15"
# "2021-08-15" "2021-09-15"

```

#
By lead time

What quality of the PCA are we leveraging

Comparing with 10 training years 

